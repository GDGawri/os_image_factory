---
#
##
### Written by the CAT (Cloudwatt Automation Team)
##
#
- hosts: local
  user: cloud
  sudo: true

  vars:
    goblin_home: /opt/mediagoblin
  tasks:
    - name: fr_FR locale present
      locale_gen: name="{{ item }}" state=present
      with_items:
        - fr_FR.UTF-8
        - en_US.UTF-8

    - name: ansible_ssh_user can become postgres
      lineinfile: "dest=/etc/sudoers state=present regexp='^{{ ansible_ssh_user }}.*postgres.*$' line='{{ ansible_ssh_user }} ALL=(postgres) NOPASSWD: ALL' validate='visudo -cf %s'"

    - name: ansible_ssh_user can become mediagoblin
      lineinfile: "dest=/etc/sudoers state=present regexp='^{{ ansible_ssh_user }}.*mediagoblin.*$' line='{{ ansible_ssh_user }} ALL=(mediagoblin) NOPASSWD: ALL' validate='visudo -cf %s'"

    - name: apt-get update & upgrade
      apt:
        upgrade=full
        update_cache=yes

    - name: default sh is bash
      file:
        src=/bin/bash
        dest=/bin/sh
        state=link

    - name: needed packages present
      apt: pkg={{ item }} state=present
      with_items:
        - git-core
        - python
        - python-dev
        - python-lxml
        - python-imaging
        - python-virtualenv
        - npm
        - nodejs-legacy
        - automake
        - nginx
        - postgresql
        - postgresql-client
        - python-psycopg2

    - name: mediagoblin system group
      group: name=mediagoblin state=present

    - name: mediagoblin system user
      user:
        name=mediagoblin
        home=/var/lib/mediagoblin
        system=yes
        groups=www-data,mediagoblin
        comment="GNU MediaGoblin system account"
        append=true

    - name: postgres mediagoblin db present
      become_user: postgres
      postgresql_db:
        name=mediagoblin
        encoding='UTF-8'

    - name: postgres mediagoblin user present
      become_user: postgres
      postgresql_user:
        db=mediagoblin
        name=mediagoblin
        priv=ALL
        state=present

    - name: mediagoblin home created
      file:
        path={{ goblin_home }}
        state=directory
        owner=mediagoblin
        group=www-data
        mode=0755

    - name: mediagoblin git cloned
      become_user: mediagoblin
      git: '
        repo="git://git.savannah.gnu.org/mediagoblin.git"
        accept_hostkey="true"
        dest="{{ goblin_home }}"
        version="stable"
        force=yes
      '

    - name: mediagoblin submodules
      become_user: mediagoblin
      shell: git submodule init && git submodule update
      args:
        chdir: "{{ goblin_home }}"

    - name: the touchy part
      shell: ./bootstrap.sh && ./configure && make
      args:
        chdir: "{{ goblin_home }}"

    - name: mediagoblin user_dev exists
      file:
        path={{ goblin_home }}/user_dev
        state=directory
        owner=mediagoblin
        group=www-data
        mode=0750

    - name: install flup
      shell: ./bin/easy_install flup
      args:
        chdir: "{{ goblin_home }}"

    - name: ini conf files
      copy:
        src=files/{{ item }}
        dest={{ goblin_home }}/{{ item }}
        owner=mediagoblin
        group=www-data
        mode=0640
      with_items:
        - paste_local.ini
        - mediagoblin_local.ini

    - name: populate database with mediagoblin data structures
      shell: ./bin/gmg dbupdate
      args:
        chdir: "{{ goblin_home }}"

    - name: nginx started
      service: name=nginx state=started enabled=yes

    - name: mediagoblin nginx.conf set
      template:
        src=templates/mediagoblin.nginx.j2
        dest={{ goblin_home }}/nginx.conf
        owner=root
        group=root
        mode=0640

    - name: mediagoblin nginx.conf linked
      file:
        src={{ goblin_home }}/nginx.conf
        dest=/etc/nginx/sites-enabled/mediagoblin
        state=link
        force=yes

    - name: /var/log/mediagoblin exists
      file:
        path=/var/log/mediagoblin
        state=directory
        owner=mediagoblin
        group=mediagoblin
        mode=0744

    - name: initd service files
      template:
        src=templates/{{ item }}.init.j2
        dest=/etc/init.d/{{ item }}
        owner=root
        group=root
        mode=0755
      with_items:
        - mediagoblin-celery-worker
        - mediagoblin-paster

    - name: start mediagoblin
      service:
        name={{ item }}
        state=started
        enabled=yes
      with_items:
        - mediagoblin-celery-worker
        - mediagoblin-paster

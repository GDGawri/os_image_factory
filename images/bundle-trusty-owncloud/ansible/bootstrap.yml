---
#
##
### Written by the CAT (Cloudwatt Automation Team)
##
#
- hosts: local
  user: cloud
  sudo: true

  tasks:
    - name: apt-get update & upgrade
      apt:
        upgrade=full
        update_cache=yes

    - name: apt repository installed
      apt_repository:
        repo='deb http://download.opensuse.org/repositories/isv:/ownCloud:/community/xUbuntu_14.04/ /'
        state=present

    - name: apt repository key is trusted
      apt_key:
        url=http://download.opensuse.org/repositories/isv:/ownCloud:/community/xUbuntu_14.04/Release.key
        state=present

    - name: owncloud installed
      apt:
        update_cache=yes
        pkg=owncloud
        state=present
        force=yes

    - name: apache started
      service:
        name=apache2
        state=started
        enabled=yes

    - name: apache site configured
      copy:
        src=files/owncloud.apache2.conf
        dest=/etc/apache2/sites-available/owncloud.apache2.conf
        owner=root
        group=root
        mode=0644

    - name: apache rewrite module activated
      apache2_module:
        name=rewrite
        state=present

    - name: enable apache site
      shell: "/usr/sbin/a2dissite 000-default && /usr/sbin/a2ensite owncloud.apache2.conf"

    - name: "restart apache"
      service:
        name=apache2
        state=restarted

  handlers:
